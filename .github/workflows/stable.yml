name: Deploy NestJS Stable to VPS

on:
  push:
    branches:
      - stable  # Trigger only on stable branch

jobs:
  deploy-stable:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Deploy to VPS (Stable)
        uses: appleboy/ssh-action@v1
        with:
          host: 88.222.213.106
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Load NVM
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20
            node -v
            npm -v

            echo "Deploying NestJS app (stable branch)..."

            # Go to stable folder
            cd ~/office_work/AAONISA-BACKEND-STABLE || exit 1

            # Pull latest stable code
            git pull origin stable || { echo 'Git pull failed'; exit 1; }

            # Install dependencies
            npm install || { echo 'npm install failed'; exit 1; }
            echo "Stopping PM2 apps..."
            pm2 stop stable-backend-api || true
            pm2 stop stable-backend-worker || true
            
            # Build project
            echo "Running build..."
            npm run build || exit 1

            echo "Checking build output..."
            for i in {1..10}; do
              [ -f dist/src/main.js ] && break
              echo "Waiting for build output..."
              sleep 1
            done
            [ -f dist/src/main.js ] || { echo "Build output missing"; exit 1; }
            # Restart PM2 processes for stable
            pm2 reload stable-backend-api || { echo 'PM2 stable-backend-api restart failed'; exit 1; }
            pm2 reload stable-backend-worker || { echo 'PM2 stable-backend-worker restart failed'; exit 1; }

            echo "Stable deployment finished successfully âœ…"
            pm2 save
